def image = 'jmpcba/hc_infra_build:latest'
def ansi = 'gnome-terminal'

docker.image(image).inside{
    stage('Clone'){
        checkout scm
    }
    withCredentials([string(credentialsId: 'DB_MASTER_PASSWORD', variable: 'TF_VAR_db_password')]) {
        withCredentials([string(credentialsId: 'DB_MASTER_PASSWORD', variable: 'TF_VAR_db_password')]) {
            if (!params.APPLY){
                stage('Plan') {
                    ansiColor(ansi) {
                        echo "##################"
                        echo "# TERRAFORM PLAN #"
                        echo "##################"
                        dir('infra') {
                            sh '''
                                set +x
                                terraform version
                                terraform get
                                terraform init
                                terraform plan
                                '''
                            }
                        }
                    }
                }


            if (params.APPLY){
                stage('Apply') {
                    ansiColor(ansi) {
                        echo "###################"
                        echo "# TERRAFORM APPLY #"
                        echo "###################"
                        
                        dir('infra') {
                            sh '''
                            set +x
                            terraform version
                            terraform get
                            terraform init
                            terraform apply -auto-approve
                            '''
                        }
                    }
                }
            }
        }
    }
}